# Dockerfile.python-distroless (üîí S√âCURIT√â MAXIMALE - Python distroless Debian 12)
# Ce Dockerfile utilise une image distroless Python Debian 12 pour une s√©curit√© maximale

# ===================================
# √âTAPE 1 : BUILDER S√âCURIS√â
# ===================================
FROM python:3.11-slim-bookworm AS builder

# Installer les outils de s√©curit√© et de build
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    gcc \
    g++ \
    && rm -rf /var/lib/apt/lists/*

# Installer Poetry avec version fixe pour la reproductibilit√©
RUN pip install --no-cache-dir --upgrade pip==24.0.0 poetry==1.8.3

# D√©finir les variables d'environnement Poetry s√©curis√©es
ENV POETRY_NO_INTERACTION=1 \
    POETRY_VENV_IN_PROJECT=1 \
    POETRY_CACHE_DIR=/tmp/poetry_cache

WORKDIR /app

# Copier uniquement les fichiers de d√©pendances (optimisation du cache)
COPY pyproject.toml poetry.lock* ./

# Cr√©er un environnement virtuel et installer les d√©pendances
RUN python -m venv /opt/venv && \
    /opt/venv/bin/pip install --no-cache-dir --upgrade pip==24.0.0

# Exporter et installer les d√©pendances dans le venv
RUN poetry export -f requirements.txt --output requirements.txt --without-hashes --only=main && \
    /opt/venv/bin/pip install --no-cache-dir -r requirements.txt && \
    /opt/venv/bin/pip install --no-cache-dir uvicorn[standard]==0.24.0

# ===================================
# √âTAPE 2 : DISTROLESS PYTHON DEBIAN 12
# ===================================
FROM gcr.io/distroless/python3-debian12

# D√©finir les variables d'environnement Python
ENV PYTHONPATH=/opt/venv/lib/python3.11/site-packages \
    PATH=/opt/venv/bin:$PATH

# D√©finir le r√©pertoire de travail
WORKDIR /app

# Copier l'environnement virtuel complet depuis le builder
COPY --from=builder /opt/venv /opt/venv

# Copier le code applicatif
COPY app /app/app

# Exposer le port
EXPOSE 8000

# Lancer l'application avec le module Python uvicorn
# Dans distroless, on utilise python -m au lieu du binaire direct
ENTRYPOINT ["/usr/bin/python3", "-m", "uvicorn"]
CMD ["app.main:app", "--host", "0.0.0.0", "--port", "8000"]

# Avantages de l'image distroless Python :
# 1. Surface d'attaque minimale (pas de shell, pip, etc.)
# 2. Taille r√©duite (seulement le runtime Python)
# 3. S√©curit√© renforc√©e (impossible d'ex√©cuter des commandes)
# 4. Pas de package manager en production
# 5. Impossibilit√© d'installer des outils malveillants
# 6. Conformit√© aux standards de s√©curit√©